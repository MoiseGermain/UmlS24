pipeline {
  agent {
    kubernetes {
      yaml """
                apiVersion: v1
                kind: Pod
                spec:
                  containers:
                  - name: gradle
                    image: gradle
                    command:
                    - sleep
                    args:
                    - 99d
                    volumeMounts:
                    - name: shared-storage
                      mountPath: /mnt        
                  - name: kaniko
                    image: gcr.io/kaniko-project/executor:debug
                    command:
                    - sleep
                    args:
                    - 9999999
                    volumeMounts:
                    - name: shared-storage
                      mountPath: /mnt
                    - name: kaniko-secret
                      mountPath: /kaniko/.docker
                  restartPolicy: Never
                  volumes:
                  - name: shared-storage
                    persistentVolumeClaim:
                      claimName: jenkins-pv-claim
                  - name: kaniko-secret
                    secret:
                        secretName: dockercred
                        items:
                        - key: .dockerconfigjson
                          path: config.json
            """
       }
  }
  stages {
    stage('Checkout code AND run tests') {

      steps {
       script {

          // For testing as a normal pipeline, I am setting this manually. A multibranch will have this set already when the pull request (for example) triggers.
          env.BRANCH_NAME = "master"
        }          

        git url: 'https://github.com/moisegermain/Continuous-Delivery-with-Docker-and-Jenkins-Second-Edition.git'
        container('gradle') {

        sh """
          cd Chapter08/sample1
          chmod +x gradlew
          // compile and test

        """

        }
      }
    }
  }
  
  post {
    success {
      script {
        echo "Post success script: " + env.BRANCH_NAME
        if ( env.BRANCH_NAME == 'main' ) {
          echo "Create container repository/calculator:1.0"

          container('kaniko') {
                    sh '''
                    echo IN KANIKO CONTAINER
                    '''
                }

        }
      }
    }
  }
}
